name: Build Dylib

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Build Injectable Dylib
    runs-on: macos-latest

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Build Dylib
        run: |
          mkdir -p dist
          SDK_PATH="$(xcrun --sdk iphoneos --show-sdk-path)"
          clang \
            -isysroot "$SDK_PATH" \
            -arch arm64 \
            -miphoneos-version-min=14.0 \
            -fobjc-arc \
            -framework Foundation \
            -dynamiclib \
            -Wl,-install_name,@rpath/BackwardsTime.dylib \
            -o dist/BackwardsTime.dylib \
            BackwardsTime.m
          install_name_tool -id @rpath/BackwardsTime.dylib dist/BackwardsTime.dylib
          codesign -f -s - dist/BackwardsTime.dylib
          file dist/BackwardsTime.dylib
          lipo -info dist/BackwardsTime.dylib

      - name: Upload Dylib Artifact
        uses: actions/upload-artifact@v4
        with:
          name: BackwardsTime-Injectable-Dylib
          path: dist/*
